<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Burung Runner</title>
  <style>
    /* Pastikan kanvas selalu full-screen dan tidak ikut scroll */
    html, body { height: 100%; margin: 0; }
    body {
      background: #000;
      overscroll-behavior: none;
      -webkit-user-select: none;
      user-select: none;
      touch-action: none; /* matikan geser/zoom saat main di HP */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    #gameCanvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
    }
    #btnRestart {
      position: fixed;
      left: 50%;
      top: calc(50% + 80px);
      transform: translateX(-50%);
      padding: 14px 18px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      background: #5b8cff;
      color: white;
      box-shadow: 0 8px 20px rgba(91,140,255,.35);
      display: none;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <button id="btnRestart">Main lagi</button>
  <script>
    'use strict';
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d', { alpha: false });
    const btnRestart = document.getElementById('btnRestart');

    // --- Sizing & DPR ---
    function resizeCanvas() {
      // Ukuran visual (CSS pixel)
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.min(window.devicePixelRatio || 1, 2); // batasi supaya tidak terlalu berat
      // Set ukuran buffer (device pixel)
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      // Skala agar menggambar pakai satuan CSS pixel
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // --- Assets ---
    const birdImg = new Image();
    birdImg.src = './logo.png'; // letakkan logo.png di folder yang sama dengan index.html

    // --- Game State ---
    let W = 0, H = 0, groundY = 0;
    let state = 'menu'; // menu | playing | gameover
    let lastTime = 0;
    let score = 0;
    let highScore = 0;
    let speed = 300;   // px per detik
    let gravity = 1800;
    let jumpVel = -800;
    let spawnTimer = 0;

    const bird = {
      x: 0, y: 0, w: 0, h: 0, vy: 0
    };
    const obstacles = []; // {x,y,w,h}

    function layout() {
      // Hitung ulang berdasarkan ukuran canvas (pakai CSS px)
      W = canvas.clientWidth;
      H = canvas.clientHeight;
      groundY = Math.floor(H * 0.85);
      const targetW = Math.min(120, Math.max(60, W * 0.18));
      bird.w = targetW;
      bird.h = targetW;
      bird.x = Math.floor(W * 0.18);
      if (state === 'menu' || state === 'gameover') {
        bird.y = groundY - bird.h;
      }
    }
    layout();

    function resetGame() {
      obstacles.length = 0;
      score = 0;
      speed = 320;
      spawnTimer = 0.2;
      bird.vy = 0;
      bird.y = groundY - bird.h;
      state = 'playing';
      btnRestart.style.display = 'none';
      lastTime = performance.now();
      requestAnimationFrame(loop);
    }

    function spawnObstacle() {
      const minH = Math.max(30, H * 0.06);
      const maxH = Math.max(minH + 20, H * 0.16);
      const h = Math.floor(minH + Math.random() * (maxH - minH));
      const w = Math.floor(h * (0.6 + Math.random() * 0.6)); // proporsional
      const x = W + w + 10;
      const y = groundY - h;
      obstacles.push({ x, y, w, h, passed: false });
      // Jadwal spawn berikutnya
      const minGap = Math.max(160, W * 0.25);
      const maxGap = Math.max(minGap + 40, W * 0.45);
      const gapPx = minGap + Math.random() * (maxGap - minGap);
      spawnTimer = gapPx / speed; // konversi jarak ke detik
    }

    function jump() {
      if (state === 'menu') {
        resetGame();
        return;
      }
      if (state !== 'playing') return;
      // loncat hanya kalau di tanah (sedikit toleransi)
      if (bird.y >= groundY - bird.h - 2) {
        bird.vy = jumpVel;
      }
    }

    // Input
    window.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      jump();
    }, { passive: false });

    // Cegah double-tap zoom iOS
    let lastTouch = 0;
    window.addEventListener('touchend', (e) => {
      const now = Date.now();
      if (now - lastTouch <= 300) e.preventDefault();
      lastTouch = now;
    }, { passive: false });

    btnRestart.addEventListener('click', resetGame);

    function update(dt) {
      if (state !== 'playing') return;

      // physics burung
      bird.vy += gravity * dt;
      bird.y += bird.vy * dt;
      if (bird.y > groundY - bird.h) {
        bird.y = groundY - bird.h;
        bird.vy = 0;
      }

      // obstacles
      for (let i = 0; i < obstacles.length; i++) {
        const o = obstacles[i];
        o.x -= speed * dt;
        // skor saat melewati
        if (!o.passed && o.x + o.w < bird.x) {
          o.passed = true;
          score += 1;
          if (score % 5 === 0) speed += 20; // makin cepat
        }
        // hapus di luar layar
        if (o.x + o.w < -10) {
          obstacles.splice(i, 1);
          i--;
        }
        // cek tabrakan (AABB)
        if (rectsOverlap(bird.x + 8, bird.y + 8, bird.w - 16, bird.h - 10, o.x, o.y, o.w, o.h)) {
          gameOver();
        }
      }

      // spawn jadwal
      spawnTimer -= dt;
      if (spawnTimer <= 0) spawnObstacle();
    }

    function rectsOverlap(ax, ay, aw, ah, bx, by, bw, bh) {
      return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
    }

    function drawBackground() {
      // langit gradasi
      const g = ctx.createLinearGradient(0, 0, 0, H);
      g.addColorStop(0, '#9ad6ff');
      g.addColorStop(1, '#ffffff');
      ctx.fillStyle = g;
      ctx.fillRect(0, 0, W, H);
      // tanah
      ctx.fillStyle = '#2b2b2b';
      ctx.fillRect(0, groundY, W, H - groundY);
      // garis tanah
      ctx.fillStyle = '#1b1b1b';
      ctx.fillRect(0, groundY - 4, W, 4);
    }

    function drawBird() {
      if (birdImg.complete && birdImg.naturalWidth > 0) {
        ctx.drawImage(birdImg, bird.x, bird.y, bird.w, bird.h);
      } else {
        // fallback placeholder jika gambar belum load
        ctx.fillStyle = '#5865F2';
        ctx.fillRect(bird.x, bird.y, bird.w, bird.h);
      }
    }

    function drawObstacles() {
      ctx.fillStyle = '#333';
      for (const o of obstacles) {
        ctx.fillRect(o.x, o.y, o.w, o.h);
        // aksen
        ctx.fillStyle = '#4a4a4a';
        ctx.fillRect(o.x + 4, o.y, 6, o.h);
        ctx.fillStyle = '#333';
      }
    }

    function drawHUD() {
      ctx.fillStyle = '#000';
      ctx.globalAlpha = 0.2;
      ctx.fillRect(12, 12, 120, 44);
      ctx.globalAlpha = 1;
      ctx.fillStyle = '#fff';
      ctx.font = '24px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.textBaseline = 'top';
      ctx.fillText('Skor: ' + score, 20, 20);
    }

    function drawMenuOverlay() {
      ctx.fillStyle = 'rgba(0,0,0,.25)';
      ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = '#111';
      ctx.font = 'bold 28px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Burung Runner', W/2, H/2 - 60);
      ctx.font = '20px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Tap untuk Lompat', W/2, H/2 - 20);
      ctx.fillText('Hindari rintangan. Kumpulkan skor.', W/2, H/2 + 12);
    }

    function drawGameOverOverlay() {
      ctx.fillStyle = 'rgba(0,0,0,.35)';
      ctx.fillRect(0, 0, W, H);
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      ctx.font = 'bold 28px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Game Over', W/2, H/2 - 40);
      ctx.font = '20px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Skor: ' + score + '   Rekor: ' + highScore, W/2, H/2);
      btnRestart.style.display = 'block';
    }

    function gameOver() {
      if (state !== 'playing') return;
      state = 'gameover';
      highScore = Math.max(highScore, score);
      draw(); // render sekali biar overlay terlihat
      btnRestart.style.display = 'block';
    }

    function draw() {
      layout(); // pastikan ukuran sesuai saat toolbar hp berubah
      drawBackground();
      drawObstacles();
      drawBird();
      drawHUD();
      if (state === 'menu') drawMenuOverlay();
      if (state === 'gameover') drawGameOverOverlay();
    }

    function loop(now) {
      const t = now || performance.now();
      const dt = Math.min(0.033, (t - lastTime) / 1000) || 0;
      lastTime = t;

      update(dt);
      draw();

      if (state === 'playing') {
        requestAnimationFrame(loop);
      }
    }

    // Mulai di menu, render 1x saat gambar sudah siap
    birdImg.onload = () => { resizeCanvas(); draw(); };
    birdImg.onerror = () => { console.warn('logo.png gagal dimuat. Pastikan nama & lokasi benar.'); draw(); };
    // Render awal kalau gambar cache-hit
    if (birdImg.complete) { draw(); }
  </script>
</body>
</html>
